---
title: "Observatorio Econ√≥mico RD"
format: 
  dashboard:
    css: styles.css 
    nav-buttons: [github]
    theme: 
      light: cosmo       # Mantenemos esto para que el dashboard sepa
      dark: darkly   
    scrolling: FALSE
    orientation: rows 
website:
  title: "Observatorio Econ√≥mico RD | Leonardo Mena"
  description: "Monitor en tiempo real de D√≥lar, Inflaci√≥n, TPM e IMAE en Rep√∫blica Dominicana."
  site-url: "https://leonardomena.com/observatorio"
  image: "preview.png"
---


```{r setup}
#| include: false

# -----------------------------------------------------------------------------
# 1. SETUP Y LIBRER√çAS
# -----------------------------------------------------------------------------
suppressPackageStartupMessages({
  library(tidyverse)
  library(highcharter)
  library(readxl)
  library(lubridate)
  library(httr)
  library(janitor)
  library(htmltools)
  library(DT)
  library(bslib) # Librer√≠a clave para Value Boxes modernos
  library(bsicons)
})

# Configuraci√≥n Regional Highcharts
options(highcharter.lang = list(
  months = c('Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'),
  shortMonths = c('Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'),
  weekdays = c('Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'),
  decimalPoint = ',',
  thousandsSep = '.'
))

# -----------------------------------------------------------------------------
# 2. FUNCIONES UTILITARIAS Y TEMA
# -----------------------------------------------------------------------------

# Funci√≥n robusta para parsear meses en espa√±ol
parsear_mes <- function(mes_texto) {
  meses_abr <- c("ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic")
  texto_limpio <- tolower(str_sub(mes_texto, 1, 3))
  match(texto_limpio, meses_abr)
}

# Tema unificado
theme_observatorio <- function() {
  hc_theme(
    chart = list(
      backgroundColor = "transparent",
      style = list(
        fontFamily = "Inter, sans-serif", 
        color = "#333333"
      )
    ),
    title = list(
      style = list(
        fontFamily = "Crimson Pro, serif",
        fontWeight = "bold",
        color = "#1e1e24" # Gris casi negro
      )
    ),
    # Eje X con l√≠nea gu√≠a en Terracota
    xAxis = list(
      gridLineWidth = 0,
      lineColor = "#e0e0e0",
      tickColor = "#e0e0e0",
      labels = list(style = list(color = "#666666")),
      crosshair = list(
        width = 1,
        color = "#c86448", # <--- Terracota para la gu√≠a
        dashStyle = "Dash"
      )
    ),
    yAxis = list(
      gridLineWidth = 1,
      gridLineColor = "#f0f0f0", # Grillas muy sutiles
      gridLineDashStyle = "Dash",
      labels = list(style = list(color = "#666666"))
    ),
    tooltip = list(
      backgroundColor = "#ffffff",
      borderColor = "#c86448", # Borde Terracota
      borderWidth = 1,
      style = list(color = "#333", fontFamily = "Inter, sans-serif"),
      shadow = TRUE,
      padding = 10
    ),
    legend = list(
      itemStyle = list(color = "#333", fontWeight = "normal"),
      itemHoverStyle = list(color = "#c86448")
    ),
    credits = list(enabled = FALSE),
    # PALETA DE COLORES EDITORIAL POR DEFECTO
    colors = c(
      "#343a40", # Gris Plomo (Principal)
      "#c86448", # Terracota (Secundario/Marca)
      "#556b2f", # Verde Oliva (Terciario)
      "#d4ac0d"  # Ocre (Auxiliar)
    )
  )
}

# Funci√≥n para descarga de datos (Optimizada)
generar_boton_descarga <- function(df, nombre_archivo) {
  datatable(
    df, 
    extensions = 'Buttons', 
    options = list(
      dom = 'Bfrtip', 
      buttons = list(list(extend = 'csv', filename = nombre_archivo, text = 'üì• Descargar Data', className = 'btn-sm')),
      pageLength = 5,
      scrollY = "300px", # Scroll interno para que no ocupe mucho espacio
      scrollCollapse = TRUE
    ),
    class = "display compact"
  )
}
```

``` {r data-fetching}
#| include: false
#| cache: false

# --- 1. CONFIGURACI√ìN DE URLS ---
urls <- list(
  dolar = "https://cdn.bancentral.gov.do/documents/estadisticas/mercado-cambiario/documents/TASA_DOLAR_REFERENCIA_MC.xlsx",
  tpm   = "https://cdn.bancentral.gov.do/documents/estadisticas/sector-monetario-y-financiero/documents/Serie_TPM.xlsx",
  ipc   = "https://cdn.bancentral.gov.do/documents/estadisticas/precios/documents/ipc_base_2019-2020.xls",
  imae  = "https://cdn.bancentral.gov.do/documents/estadisticas/sector-real/documents/imae_2018.xlsx"
)

# --- 2. FUNCIONES DE EXTRACCI√ìN (Restauradas al estilo original) ---

# D√ìLAR
obtener_dolar <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xlsx")
    # Configuraci√≥n original simple: solo ignorar SSL
    GET(urls$dolar, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = 0))
    
    raw <- read_excel(tf, sheet = "Diaria", col_names = FALSE, skip = 4)
    
    clean <- raw %>%
      select(1, 2, 3, 5) %>%
      set_names(c("anio", "mes", "dia", "tasa_venta")) %>%
      mutate(across(c(anio, dia, tasa_venta), ~suppressWarnings(as.numeric(.)))) %>%
      mutate(mes_num = parsear_mes(mes)) %>%
      filter(!is.na(anio), !is.na(mes_num), !is.na(dia), !is.na(tasa_venta)) %>%
      mutate(fecha = make_date(anio, mes_num, dia)) %>%
      arrange(fecha) %>%
      select(fecha, tasa_venta)
      
    return(clean)
  }, error = function(e) {
    message("‚ùå Error descargando D√≥lar: ", e$message) # <--- AQU√ç VEREMOS EL ERROR REAL
    return(data.frame(fecha = Sys.Date(), tasa_venta = 0))
  })
}

# TPM
obtener_tpm <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xlsx")
    
    # 1. Descarga simple (como en el diagn√≥stico)
    GET(urls$tpm, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = 0))
    
    # 2. Lectura directa
    # Usamos tryCatch interno por si es xls antiguo, pero priorizamos xlsx
    raw <- tryCatch(
      read_excel(tf, col_names = FALSE, skip = 6),
      error = function(e) {
         # Si falla, intentamos copiar a extensi√≥n .xls por si acaso
         tf2 <- tempfile(fileext = ".xls")
         file.copy(tf, tf2)
         read_excel(tf2, col_names = FALSE, skip = 6)
      }
    )
    
    # 3. Limpieza (Id√©ntica a tu script de prueba)
    clean <- raw %>%
      select(anio_raw = ...1, mes = ...2, tpm = ...3) %>%
      fill(anio_raw, .direction = "down") %>%
      mutate(
        # Forzamos num√©ricos para evitar errores de tipo
        anio = suppressWarnings(as.numeric(anio_raw)),
        tpm  = suppressWarnings(as.numeric(tpm)),
        mes_num = parsear_mes(as.character(mes))
      ) %>%
      # Filtramos filas inv√°lidas
      filter(!is.na(anio), !is.na(mes_num), !is.na(tpm)) %>%
      # Creamos fecha
      mutate(fecha = make_date(anio, mes_num, 1)) %>%
      # Ordenamos para el gr√°fico (Viejo -> Nuevo)
      arrange(fecha) %>%
      select(fecha, tpm)
      
    unlink(tf)
    return(clean)
    
  }, error = function(e) {
    message("‚ùå Error en TPM: ", e$message)
    return(data.frame(fecha = Sys.Date(), tpm = 0))
  })
}

# IPC
obtener_ipc <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xls")
    GET(urls$ipc, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = 0))
    
    raw <- read_excel(tf, col_names = FALSE, skip = 6)
    
    clean <- raw %>%
      select(anio = ...1, mes = ...2, doce_meses = ...6) %>%
      fill(anio, .direction = "down") %>%
      mutate(anio = as.numeric(anio), doce_meses = as.numeric(doce_meses)) %>%
      mutate(mes_num = parsear_mes(as.character(mes))) %>%
      filter(!is.na(anio), !is.na(mes_num), !is.na(doce_meses)) %>%
      mutate(fecha = make_date(anio, mes_num, 1)) %>%
      arrange(desc(fecha)) %>%
      select(fecha, doce_meses)
      
    return(clean)
  }, error = function(e) {
    message("‚ùå Error descargando IPC: ", e$message)
    return(data.frame(fecha = Sys.Date(), doce_meses = 0))
  })
}

# --- OBTENER IMAE (Sector Real) ---
obtener_imae <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xlsx")
    GET(urls$imae, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = 0))
    
    # Leemos saltando el encabezado (generalmente 5-6 filas en este archivo)
    # Col A=A√±o, B=Mes, C=Indice, D=Var.Mensual, E=Var.Acumulada
    raw <- read_excel(tf, col_names = FALSE, skip = 6)
    
    clean <- raw %>%
      select(anio_raw = ...1, mes = ...2, var_mensual = ...4, var_acum = ...5) %>%
      # 1. Rellenar A√±os (El a√±o solo aparece en enero, los dem√°s son NA)
      fill(anio_raw, .direction = "down") %>%
      # 2. Convertir a num√©ricos para evitar filas de texto basura
      mutate(
        anio = suppressWarnings(as.numeric(anio_raw)),
        var_mensual = suppressWarnings(as.numeric(var_mensual)),
        var_acum = suppressWarnings(as.numeric(var_acum))
      ) %>%
      # 3. FILTRO CR√çTICO: Eliminar filas "Promedio", "Trimestre" o vac√≠as
      filter(
        !is.na(anio), 
        !is.na(mes),
        !str_detect(mes, "Promedio|promedio|Trimestre|Semestre|Total") # <--- Tu petici√≥n
      ) %>%
      # 4. Parsear mes (Tu funci√≥n ya maneja "Enero" -> "ene" -> 1)
      mutate(mes_num = parsear_mes(mes)) %>%
      filter(!is.na(mes_num)) %>% # Seguridad extra
      # 5. Crear fecha
      mutate(fecha = make_date(anio, mes_num, 1)) %>%
      arrange(fecha) %>%
      select(fecha, var_mensual, var_acum)
    
    unlink(tf)
    
    if(nrow(clean) == 0) stop("IMAE vac√≠o tras limpieza")
    return(clean)
    
  }, error = function(e) {
    message("‚ùå Error en IMAE: ", e$message)
    return(data.frame(fecha = Sys.Date(), var_mensual = 0, var_acum = 0))
  })
}

# --- 3. EJECUCI√ìN Y C√ÅLCULOS KPI ---
df_dolar <- obtener_dolar()
df_tpm   <- obtener_tpm()
df_ipc   <- obtener_ipc()
df_imae  <- obtener_imae()
# C√°lculos D√≥lar
hoy_dolar  <- tail(df_dolar, 1)
ayer_dolar <- tail(df_dolar, 2) %>% head(1)

# C√ÅLCULOS IMAE
val_imae <- tail(df_imae, 1) # √öltimo dato disponible
# Prevenci√≥n si viene vac√≠o
if(nrow(df_dolar) > 1 && hoy_dolar$tasa_venta > 0) {
  diff_dolar <- hoy_dolar$tasa_venta - ayer_dolar$tasa_venta
  pct_dolar  <- (diff_dolar / ayer_dolar$tasa_venta) * 100
} else {
  diff_dolar <- 0; pct_dolar <- 0
}

icon_dolar  <- if(diff_dolar >= 0) "arrow-up-short" else "arrow-down-short"
color_dolar <- if(diff_dolar >= 0) "danger" else "success" 

val_ipc <- head(df_ipc, 1)
val_tpm <- tail(df_tpm, 1)
```

# Indicadores {orientation="rows"}

## Row {height="280px" expandable="false"}

```{r}
#| expandable: false
#| classes: no-expand
value_box(
  title = "D√≥lar Spot (Venta)",
  value = paste0("RD$ ", format(round(hoy_dolar$tasa_venta, 2), nsmall=2)),
  showcase = bs_icon("currency-dollar"),
  theme = "light",
  full_screen = FALSE,
  p(
    bs_icon(icon_dolar), 
    paste0(round(abs(diff_dolar), 2), " (", round(pct_dolar, 2), "%)"),
    class = paste0("text-", color_dolar)
  ),
  p(paste0("Act: ", format(hoy_dolar$fecha, "%d %b")), class = "text-muted fs-6")
)
```

```{r}
#| classes: no-expand
value_box(
  title = "Inflaci√≥n Interanual",
  value = paste0(format(round(val_ipc$doce_meses, 2), nsmall=2), "%"),
  showcase = bs_icon("graph-up"),
  theme = "light",
  expandable = FALSE,
  p("Meta: 4.0% ¬± 1%", class = "text-secondary"),
  p(paste0("Datos: ", format(val_ipc$fecha, "%b %Y")), class = "text-muted fs-6")
)
```

```{r}
#| classes: no-expand
value_box(
  title = "Tasa Pol√≠tica Monetaria",
  value = paste0(format(round(val_tpm$tpm * 100, 2), nsmall=2), "%"),
  showcase = bs_icon("bank2"),
  theme = "light",
  expandable = FALSE,
  p("Referencia BCRD", class = "text-secondary"),
  p(paste0("Datos: ", format(val_tpm$fecha, "%b %Y")), class = "text-muted fs-6")
)
```

```{r}
#| classes: no-expand
value_box(
  title = "Actividad Econ√≥mica (IMAE)",
  value = paste0(format(round(val_imae$var_mensual, 1), nsmall=1), "%"),
  showcase = bs_icon("buildings"), # Icono de edificio/industria
  theme = "light",
  p(
    "Acumulada: ", 
    strong(paste0(round(val_imae$var_acum, 1), "%")),
    class = "text-secondary"
  ),
  p(paste0("Datos: ", format(val_imae$fecha, "%b %Y")), class = "text-muted fs-6")
)
```
## Row {height="fill"}
::: {.panel-tabset}
### D√≥lar
```{r}
#| title: "Evoluci√≥n D√≥lar"
#| expandable: false
data_grafico <- tail(df_dolar, 365)
promedio <- mean(data_grafico$tasa_venta)

hchart(data_grafico, "line", hcaes(x = fecha, y = tasa_venta), color = "#546e7a", name = "Venta") %>%
  hc_title(text = "D√≥lar Spot (√öltimos 12 meses)") %>%
  hc_yAxis(
    title = list(text = ""),
    plotLines = list(list(value = promedio, color = "#90a4ae", dashStyle = "ShortDash", label = list(text = "Promedio")))
  ) %>%
  hc_tooltip(pointFormat = "RD$ {point.y:,.2f}") %>%
  hc_add_theme(theme_observatorio()) |> 
  hc_credits(
    enabled = TRUE, 
    text = "Fuente: Banco Central de la R.D. | Elaboraci√≥n: Leonardo Mena",
    style = list(fontSize = "10px", color = "#999")
  )
```


### Inflacion
```{r}
#| expandable: false
df_ipc_reciente <- head(df_ipc, 48)

hchart(df_ipc_reciente, "line", hcaes(x = fecha, y = doce_meses), color = "#c86448", name = "Inflaci√≥n") %>%
  hc_title(text = "Inflaci√≥n (√öltimos 4 a√±os)") %>%
  hc_yAxis(title = list(text = ""),
    plotLines = list(
      # Banda de Meta (Gris muy suave para el fondo)
      list(
        color = "#f4f4f4", 
        from = 3.0, to = 5.0, 
        label = list(text = ""), 
        zIndex = 1
      ),
      # L√≠nea Meta (Gris oscuro punteado, serio)
      list(
        value = 4.0, 
        color = "#333333", 
        dashStyle = "ShortDash", 
        width = 1,
        label = list(text = "Meta 4.0%", align = "right", style = list(color = "#666")),
        zIndex = 2
      )
    )
  ) %>%
  hc_tooltip(pointFormat = "{point.y:.2f}%") %>%
  hc_add_theme(theme_observatorio()) |> 
  hc_credits(
    enabled = TRUE, 
    text = "Fuente: Banco Central de la R.D. | Elaboraci√≥n: Leonardo Mena",
    style = list(fontSize = "10px", color = "#999")
  )
```


### TPM
```{r}
#| expandable: false
# Preparamos datos: Filtramos √∫ltimos 7 a√±os y convertimos a porcentaje
df_tpm_grafico <- df_tpm %>% 
  arrange(desc(fecha)) %>% # Ordenar para head()
  head(84) %>%             # Tomar √∫ltimos 84 meses
  arrange(fecha) %>%       # Reordenar cronol√≥gico para el gr√°fico
  mutate(tpm_pct = tpm * 100) # Convertir 0.07 a 7.0

hchart(
  df_tpm_grafico, 
  "area", 
  hcaes(x = fecha, y = tpm_pct), 
  color = "#556b2f", # <--- CAMBIO: Verde Oliva
  fillColor = list(
    linearGradient = list(x1 = 0, y1 = 0, x2 = 0, y2 = 1),
    stops = list(
      list(0, "rgba(85, 107, 47, 0.5)"), # Oliva semi-transparente arriba
      list(1, "rgba(255, 255, 255, 0)")  # Transparente abajo
    )
  ),
  name = "TPM",
  step = "left"
) %>%
  hc_title(text = "Tasa de Pol√≠tica Monetaria") %>%
  hc_yAxis(title = list(text = ""),
    labels = list(format = "{value}%")) %>%
  hc_tooltip(pointFormat = "TPM: <b>{point.y:.2f}%</b>", xDateFormat = "%B %Y") %>%
  hc_add_theme(theme_observatorio()) |> 
  hc_credits(
    enabled = TRUE, 
    text = "Fuente: Banco Central de la R.D. | Elaboraci√≥n: Leonardo Mena",
    style = list(fontSize = "10px", color = "#999")
  )
```


### IMAE
```{r}
#| expandable: false
# √öltimos 48 meses (4 a√±os)
df_imae_grafico <- tail(df_imae, 48)

hchart(
  df_imae_grafico, 
  "column", # <--- Columnas para diferenciarlo de precios
  hcaes(x = fecha, y = var_mensual), 
  color = "#343a40", # Gris Plomo (Tu estilo Editorial)
  name = "IMAE Mensual"
) %>%
  hc_title(text = "Actividad Econ√≥mica (IMAE)") %>%
  hc_subtitle(text = "Variaci√≥n interanual del √≠ndice (%)") %>%
  hc_yAxis(
    title = list(text = "Crecimiento %"),
    plotLines = list(list(
      value = 0, 
      color = "#333", 
      width = 2 # L√≠nea base del 0% marcada fuerte
    ))
  ) %>%
  hc_tooltip(
    pointFormat = "Variaci√≥n Mensual: <b>{point.y:.1f}%</b><br/>"
  ) %>%
  hc_add_theme(theme_observatorio()) |> 
  hc_credits(
    enabled = TRUE, 
    text = "Fuente: Banco Central de la R.D. | Elaboraci√≥n: Leonardo Mena",
    style = list(fontSize = "10px", color = "#999")
  )
```
:::

# Descargar data
::: {.panel-tabset}
### ‚¨áÔ∏è Descargar Datos Hist√≥ricos TPM
```{r}
generar_boton_descarga(df_tpm, "TPM_Historico")
```
### ‚¨áÔ∏è Descargar Datos Hist√≥ricos Inflacion
```{r}
generar_boton_descarga(df_ipc, "IPC_Historico")
```

### ‚¨áÔ∏è Descargar Datos Hist√≥ricos Dolar
```{r}
# Bot√≥n de descarga peque√±o y discreto
generar_boton_descarga(df_dolar, "Dolar_Historico")
```

### ‚¨áÔ∏è Descargar Datos Hist√≥ricos IMAE
```{r}
generar_boton_descarga(df_imae, "IMAE_Historico_RD")
```
:::