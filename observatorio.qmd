---
title: "Observatorio Económico RD"
format: 
  dashboard:
    css: styles.css  # <--- Asegúrate de vincular tu CSS aquí
    nav-buttons: [github]
    theme: 
      light: cosmo       # Mantenemos esto para que el dashboard sepa
      dark: darkly   
    scrolling: true 
---


```{r setup}
#| include: false

# ============================================================================
# OBSERVATORIO ECONÓMICO RD - CÓDIGO UNIFICADO
# ============================================================================

suppressPackageStartupMessages({
  library(tidyverse)
  library(highcharter)
  library(readxl)
  library(lubridate)
  library(httr)
  library(janitor)
  library(htmltools)
  library(DT)
})

options(highcharter.lang = list(
  months = c('Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'),
  shortMonths = c('Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'),
  weekdays = c('Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'),
  decimalPoint = ',',
  thousandsSep = '.'
))
theme_observatorio <- function() {
  hc_theme(
    chart = list(
      backgroundColor = "transparent",
      style = list(
        fontFamily = "Inter, sans-serif",
        color = "var(--lm-text)"
      )
    ),
    title = list(
      style = list(
        fontFamily = "Crimson Pro, serif",
        fontWeight = "bold",
        color = "var(--lm-text)"
      )
    ),
    subtitle = list(
      style = list(
        fontFamily = "Inter, sans-serif",
        color = "var(--lm-text-soft)"
      )
    ),
    # Eje X con "Crosshair" (Línea guía vertical al pasar el mouse)
    xAxis = list(
      gridLineWidth = 0,
      lineColor = "var(--lm-border)",
      tickColor = "var(--lm-border)",
      labels = list(style = list(color = "var(--lm-muted)")),
      crosshair = list(
        width = 1,
        color = "var(--lm-terracota)", # Línea guía color marca
        dashStyle = "Dash"
      )
    ),
    yAxis = list(
      gridLineWidth = 1,
      gridLineColor = "var(--lm-border)",
      gridLineDashStyle = "Dash",
      labels = list(style = list(color = "var(--lm-muted)"))
    ),
    # --- LA MEJORA CLAVE: TOOLTIP REACTIVO ---
    tooltip = list(
      backgroundColor = "var(--lm-bg)",      # Fondo dinámico (Crema/Oscuro)
      borderColor = "var(--lm-terracota)",   # Borde de marca
      borderWidth = 2,
      borderRadius = 4,
      style = list(
        color = "var(--lm-text)",            # Texto dinámico
        fontFamily = "Inter, sans-serif",
        fontSize = "14px"
      ),
      shadow = TRUE,
      split = FALSE  # Un solo cuadro unificado
    ),
    # Limpieza: Adiós "Highcharts.com"
    credits = list(
      enabled = FALSE
    ),
    legend = list(
      itemStyle = list(
        fontFamily = "Inter, sans-serif",
        color = "var(--lm-text)"
      ),
      itemHoverStyle = list(
        color = "var(--lm-terracota)"
      )
    ),
    colors = c(
      "var(--dash-blue)",
      "var(--lm-terracota)", 
      "var(--lm-olive)", 
      "var(--lm-ochre)"
    )
  )
}
generar_enlace_descarga <- function(df, nombre_archivo) {
  # 1. Creamos la tabla DT con el botón de descarga CSV
  datatable(
    df, 
    extensions = 'Buttons', 
    options = list(
      dom = 'Bfrtip', # Muestra la barra de botones
      buttons = list(
        list(
          extend = 'csv',
          filename = nombre_archivo,
          text = 'Descargar CSV', # Texto del botón
          exportOptions = list(
            modifier = list(page = "all") # Asegura que se descarguen todos los datos, no solo los visibles
          )
        )
      )
    )
  )
}
fecha_actualizacion <- format(Sys.Date(), "%d %b %Y")
# --- 1. CONFIGURACIÓN DE URLS ---
urls <- list(
  dolar = "https://cdn.bancentral.gov.do/documents/estadisticas/mercado-cambiario/documents/TASA_DOLAR_REFERENCIA_MC.xlsx",
  tpm   = "https://cdn.bancentral.gov.do/documents/estadisticas/sector-monetario-y-financiero/documents/Serie_TPM.xlsx",
  ipc   = "https://cdn.bancentral.gov.do/documents/estadisticas/precios/documents/ipc_base_2019-2020.xls"
)

# Función auxiliar para meses
parsear_mes <- function(mes_texto) {
  meses_abr <- c("ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic")
  texto_limpio <- tolower(substr(mes_texto, 1, 3))
  match(texto_limpio, meses_abr)
}

# --- 2. OBTENER DÓLAR ---
obtener_dolar <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xlsx")
    GET(urls$dolar, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = 0))
    
    # Leemos saltando encabezados
    datos_dolar <- read_excel(tf, sheet = "Diaria", col_names = FALSE, skip = 4)
    
    data <- datos_dolar %>%
      select(1, 2, 3, 5) %>%
      set_names(c("anio", "mes", "dia", "tasa_venta")) %>%
      mutate(
        anio = suppressWarnings(as.numeric(anio)),
        mes_num = parsear_mes(mes),
        dia = suppressWarnings(as.numeric(dia)),
        tasa_venta = suppressWarnings(as.numeric(tasa_venta))
      ) %>%
      filter(!is.na(anio), !is.na(mes_num), !is.na(dia), !is.na(tasa_venta)) %>%
      mutate(fecha = make_date(anio, mes_num, dia)) %>%
      arrange(fecha) %>%
      select(fecha, tasa_venta)
    
    unlink(tf)
    return(data)
  }, error = function(e) {
    return(data.frame(fecha = Sys.Date(), tasa_venta = 60.50))
  })
}

# --- 3. OBTENER TPM (Mensual) ---
obtener_tpm <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xls")
    
    # Descargar el archivo
    response <- GET(urls$tpm, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = FALSE))
    
    # Verificar que la descarga fue exitosa
    if (http_error(response)) {
      stop("Error al descargar el archivo. Código HTTP: ", status_code(response))
    }
    
    # Verificar que el archivo existe y tiene contenido
    if (!file.exists(tf) || file.size(tf) == 0) {
      stop("El archivo descargado está vacío o no existe")
    }
    
    # Intentar leer el archivo (puede ser .xlsx en lugar de .xls)
    datos_tpm <- tryCatch({
      read_excel(tf, col_names = FALSE, skip = 6)
    }, error = function(e) {
      # Si falla con .xls, intentar como .xlsx
      tf_xlsx <- tempfile(fileext = ".xlsx")
      file.copy(tf, tf_xlsx)
      read_excel(tf_xlsx, col_names = FALSE, skip = 6)
    })
    
    # Procesar los datos
    data <- datos_tpm %>%
      select(anio_raw = ...1, mes = ...2, tpm = ...3) %>%
      mutate(
        anio = suppressWarnings(as.numeric(anio_raw)),
        mes = str_trim(as.character(mes)),
        tpm = suppressWarnings(as.numeric(tpm))
      ) %>%
      fill(anio, .direction = "down") %>%
      mutate(
        mes_num = case_when(
          mes == "Ene" ~ 1,
          mes == "Feb" ~ 2,
          mes == "Mar" ~ 3,
          mes == "Abr" ~ 4,
          mes == "May" ~ 5,
          mes == "Jun" ~ 6,
          mes == "Jul" ~ 7,
          mes == "Ago" ~ 8,
          mes == "Sep" ~ 9,
          mes == "Oct" ~ 10,
          mes == "Nov" ~ 11,
          mes == "Dic" ~ 12,
          TRUE ~ NA_real_
        )
      ) %>%
      filter(!is.na(anio), !is.na(mes_num), !is.na(tpm)) %>%
      mutate(fecha = make_date(anio, mes_num, 1)) %>%
      select(fecha, tpm, anio, mes) %>%
      arrange(desc(fecha))
    
    ultimo <- head(data, 1)
    unlink(tf)
    
    if (nrow(ultimo) == 0) {
      stop("No se encontraron datos válidos después del procesamiento")
    }
    
    fecha_dato <- format(ultimo$fecha, "%b %Y")
    
    return(list(
      dataframe = data,
      valor = paste0(round(ultimo$tpm, 2), "%"),
      fecha_dato = fecha_dato
    ))
    
  }, error = function(e) {
    message("Error en obtener_tpm: ", e$message)
    return(list(
      dataframe = data.frame(fecha = as.Date(character(0)), tpm = numeric(0)),
      valor = "Error",
      fecha_dato = "-"
    ))
  })
}

# --- 4. OBTENER IPC ---
obtener_ipc <- function() {
  tryCatch({
    tf <- tempfile(fileext = ".xls")
    GET(urls$ipc, write_disk(tf, overwrite = TRUE), config(ssl_verifypeer = 0))
    
    datos_ipc <- read_excel(tf, col_names = FALSE, skip = 6)
    
    data <- datos_ipc %>%
      mutate(
        anio = suppressWarnings(as.numeric(...1)),
        mes = as.character(...2),
        doce_meses = suppressWarnings(as.numeric(...6)) 
      ) %>%
      fill(anio, .direction = "down") %>%
      mutate(mes_num = parsear_mes(mes)) %>%
      filter(!is.na(anio), !is.na(mes_num), !is.na(doce_meses)) %>%
      mutate(fecha = make_date(anio, mes_num, 1)) %>%
      arrange(desc(fecha))
    
    ultimo <- head(data, 1)
    unlink(tf)
    
    fecha_dato <- format(ultimo$fecha, "%b %Y")
    
    return(list(
      dataframe = data,  # Datos para el gráfico
      valor = paste0(format(round(ultimo$doce_meses, 2), nsmall=2), "%"),
      fecha_dato = fecha_dato
    ))
  }, error = function(e) {
    # Devolver estructura funcional para evitar que el dashboard se rompa
    return(list(
      dataframe = data.frame(fecha = Sys.Date(), doce_meses = 0),
      valor = "Error", 
      fecha_dato = "-"
    ))
  })
}
# --- 5. EJECUCIÓN ---
df_dolar <- obtener_dolar() # DataFrame principal
info_tpm <- obtener_tpm()   # Lista con valor y fecha
info_ipc <- obtener_ipc()   # Lista con valor y fecha

df_ipc <- info_ipc$dataframe
df_tpm <- info_tpm$dataframe
# --- 6. CÁLCULOS DÓLAR ---
hoy_dolar  <- tail(df_dolar, 1)
ayer_dolar <- tail(df_dolar, 2) %>% head(1)

var_abs <- hoy_dolar$tasa_venta - ayer_dolar$tasa_venta
var_pct <- (var_abs / ayer_dolar$tasa_venta) * 100

# Texto grande para Value Box
txt_valor <- paste0("RD$", format(round(hoy_dolar$tasa_venta, 2), nsmall=2))

# Subtítulo (Variación)
txt_sub   <- paste0(
  ifelse(var_abs >= 0, "▲", "▼"), " ",
  format(round(abs(var_abs), 2), nsmall=2), " (",
  ifelse(var_pct >= 0, "+", ""), format(round(var_pct, 2), nsmall=2), "%)"
)

# Datos para gráfico
data_grafico <- tail(df_dolar, 365)
promedio <- mean(data_grafico$tasa_venta)

# --- 7. PIES DE PÁGINA (Caption Strings) ---
# Fecha de hoy para todos
txt_hoy <- format(Sys.Date(), "%d/%m/%Y")

# A. Caption Dólar
fecha_dolar_dato <- format(max(df_dolar$fecha), "%d %b %Y")
caption_dolar <- paste0("Datos: ", fecha_dolar_dato, " • Act: ", txt_hoy)

# B. Caption Inflación
caption_ipc <- paste0("Datos: ", info_ipc$fecha_dato, " • Act: ", txt_hoy)

# C. Caption TPM
caption_tpm <- paste0("Datos: ", info_tpm$fecha_dato, " • Act: ", txt_hoy)
```

# Indicadores {orientation="columns"}

## Column {width="30%"}

```{r}
#| content: valuebox
#| title: "Dólar Venta (Spot)"
list(
  icon = "currency-dollar",
  color = "vbox-dolar",  # <--- Nombre inventado por nosotros
  value = txt_valor,
  subtitle = txt_sub
)
```

```{r}
#| content: valuebox
#| title: "Inflación Interanual"
list(
  icon = "graph-up-arrow",
  color = "vbox-inflacion",
  value = info_ipc$valor,
  subtitle = paste("A:", info_ipc$fecha)
)
```

```{r}
#| content: "valuebox"
#| title: "Tasa Política Monetaria"
 
list(
  icon = "bank",
  color = "vbox-tpm",
  value = info_tpm$valor

    )
```

## Column {width=65%}

::: {.panel-tabset}

### Dólar
```{r}
# Filtramos los últimos 365 días para que sea "tendencia anual"
data_grafico <- tail(df_dolar, 365)
promedio <- mean(data_grafico$tasa_venta)

hchart(data_grafico, 
       "line", # Usamos 'line' para claridad del precio spot, aunque 'area' también es válido
       hcaes(x = fecha, y = tasa_venta), 
       color = "var(--lm-terracota)", # <--- USANDO LA VARIABLE DEL TEMA
       name = "Tasa de Venta"
) %>%
  hc_chart(backgroundColor = "transparent") |>
  hc_title(text = "Evolución Dólar Spot (Venta)") %>%
  hc_yAxis(
    title = list(text = "Pesos por Dólar"),
    labels = list(format = "RD${value:,.2f}"), # Formato de pesos
    plotLines = list(list(
      value = promedio, 
      color = "var(--lm-ochre)", # Línea de promedio en color ocre
      dashStyle = "ShortDash", 
      width = 1,
      label = list(text = paste0("Promedio Anual: RD$", round(promedio, 2)), align = "right")
    ))
  ) %>%
  hc_tooltip(pointFormat = "RD$ {point.y:,.2f}") %>%
  hc_credits(enabled = TRUE, text = "Fuente: Banco Central RD") %>%
  hc_add_theme(theme_observatorio())
```
### ⬇️ Descargar Datos Históricos
```{r}
generar_enlace_descarga(df_dolar, "Tasa_Cambio_Historica_RD")
```
:::

# Inflacion {orientation="columns"}
## Column {width=95%}
::: {.panel-tabset}
### Inflacion
```{r}
# Filtramos para mostrar los últimos 48 meses (4 años) de datos
# Usamos df_ipc directamente, asumiendo que ya se extrajo correctamente
df_ipc_reciente <- head(df_ipc, 48)

hchart(
  df_ipc_reciente, 
  "line", 
  hcaes(x = fecha, y = doce_meses), 
  color = "var(--lm-terracota)", 
  name = "Inflación Interanual"
) %>%
  hc_chart(backgroundColor = "transparent") |>
  hc_title(text = "Inflación Interanual (12 Meses)") %>%
  hc_subtitle(text = "Variación porcentual del Índice de Precios al Consumidor (IPC)") %>%
  hc_yAxis(
    title = list(text = "Variación %"),
    labels = list(format = "{value}%"),
    # Implementación de la banda y la línea de meta:
    plotLines = list(
      # 1. Banda de Tolerancia (3% a 5%) - Sombra rectangular
      list(
        color = "#e6e6e6", # Color suave
        from = 3.0, to = 5.0, # Rango de la meta
        label = list(text = "", style = list(fontSize = 0)), # Sin etiqueta
        zIndex = 1 # Fondo
      ),
      # 2. Línea de la meta del Banco Central (4.0%)
      list(
        value = 4.0, 
        color = "#003366", 
        dashStyle = "ShortDash", 
        width = 1,
        label = list(text = "Meta BC", align = "right", style = list(color = "#003366")),
        zIndex = 2 # Encima de la banda
      )
    )
  ) %>%
  hc_tooltip(pointFormat = "Inflación: {point.y:,.2f}%") %>%
  hc_credits(enabled = TRUE, text = paste0("Último dato: ", info_ipc$fecha_dato, " | Fuente: BCRD")) %>%
  hc_add_theme(theme_observatorio())
```
### ⬇️ Descargar Datos Históricos
```{r}
generar_enlace_descarga(df_ipc, "IPC_Historico_RD")
```
:::
# TPM
## Column {width=95%}
::: {.panel-tabset}
### TPM
```{r fig.height=5, fig.width=10, out.width='100%', out.height='500px'}
# Preparar datos: convertir TPM a porcentaje
df_tpm_reciente <- df_tpm %>%
  head(84) %>%
  mutate(tpm_pct = tpm * 100)  # Convertir de 0.0525 a 5.25

# Crear el gráfico
hchart(
  df_tpm_reciente, 
  "line",
  hcaes(x = fecha, y = tpm_pct),  # Usar tpm_pct en lugar de tpm
  color = "#6B8E23",  # Color oliva
  name = "TPM"
) %>%
  hc_chart(backgroundColor = "transparent") %>%
  hc_title(text = "Evolución de la Tasa de Política Monetaria") %>%
  hc_xAxis(
    type = "datetime",
    title = list(text = "")
  ) %>%
  hc_yAxis(
    title = list(text = "Tasa (%)"),
    labels = list(format = "{value}%"),
    min = 0
  ) %>%
  hc_plotOptions(
    series = list(
      marker = list(enabled = TRUE, radius = 3),
      states = list(hover = list(lineWidth = 3))
    )
  ) %>%
  hc_tooltip(
    pointFormat = "TPM: <b>{point.y:.2f}%</b>",
    xDateFormat = "%B %Y",
    shared = TRUE
  ) %>%
  hc_credits(
    enabled = TRUE, 
    text = paste0("Último dato: ", info_tpm$fecha_dato, " | Fuente: BCRD"),
    style = list(fontSize = "10px")
  ) %>%
  hc_add_theme(theme_observatorio())
```
### ⬇️ Descargar Datos Históricos
```{r}
generar_enlace_descarga(df_tpm, "TPM_Historico_RD")
```
:::